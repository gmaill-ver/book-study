<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>StudyBook - Â≠¶Áøí„Éé„Éº„ÉàÂÖ±Êúâ„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†</title>
    
    <!-- Firebase SDK v9 -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .header {
            background: rgba(255,255,255,0.98);
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-icon {
            font-size: 2rem;
        }

        /* „É¶„Éº„Ç∂„ÉºÊÉÖÂ†± */
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #667eea;
        }

        /* „Éú„Çø„É≥ */
        .btn {
            padding: 0.6rem 1.5rem;
            border-radius: 2rem;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102,126,234,0.5);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        /* „Éõ„Éº„É†ÁîªÈù¢ */
        .home-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* „Ç¢„ÇØ„Ç∑„Éß„É≥„Ç´„Éº„Éâ */
        .action-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .action-card {
            background: rgba(255,255,255,0.95);
            padding: 2.5rem;
            border-radius: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(102,126,234,0.1) 0%, transparent 70%);
            transition: all 0.6s;
        }

        .action-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .action-card:hover::before {
            top: -50%;
            left: -50%;
        }

        .action-card-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* „Éé„Éº„Éà„Ç∞„É™„ÉÉ„Éâ */
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .book-card {
            background: rgba(255,255,255,0.95);
            padding: 1.5rem;
            border-radius: 1rem;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .book-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.6s;
        }

        .book-card:hover::after {
            left: 100%;
        }

        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        /* „Éì„É•„Éº„Ç¢„Éº */
        .viewer-container {
            display: none;
            background: #0f0f23;
            min-height: 100vh;
            color: white;
        }

        .viewer-header {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.5);
        }

        /* „Éö„Éº„Ç∏„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        .page-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
            position: relative;
        }

        .page-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
        }

        .page-content {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            color: #2d3748;
            padding: 3rem;
            border-radius: 1rem;
            min-height: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            position: relative;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: pan-y;
        }

        .page-content.swipe-left {
            transform: translateX(-20px);
        }

        .page-content.swipe-right {
            transform: translateX(20px);
        }

        /* „Çπ„ÉØ„Ç§„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
        .swipe-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .swipe-indicator.left {
            left: 20px;
        }

        .swipe-indicator.right {
            right: 20px;
        }

        .swipe-indicator.active {
            opacity: 0.5;
        }

        /* „Éö„Éº„Ç∏„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes pageFlip {
            0% {
                transform: rotateY(0deg);
                opacity: 1;
            }
            50% {
                transform: rotateY(90deg);
                opacity: 0.5;
            }
            100% {
                transform: rotateY(0deg);
                opacity: 1;
            }
        }

        .page-flip {
            animation: pageFlip 0.6s ease-in-out;
        }

        /* ÁîªÂÉèË°®Á§∫ */
        .page-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Markdown„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çπ„Çø„Ç§„É´ */
        .markdown-body {
            line-height: 1.8;
            font-size: 1.1rem;
        }

        .markdown-body h1 {
            font-size: 2rem;
            margin: 2rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .markdown-body h2 {
            font-size: 1.6rem;
            margin: 1.5rem 0 0.75rem;
            color: #667eea;
        }

        .markdown-body h3 {
            font-size: 1.3rem;
            margin: 1rem 0 0.5rem;
        }

        .markdown-body p {
            margin-bottom: 1rem;
        }

        .markdown-body ul, .markdown-body ol {
            margin: 1rem 0 1rem 2rem;
        }

        .markdown-body li {
            margin-bottom: 0.5rem;
        }

        .markdown-body code {
            background: #f3f4f6;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.9em;
        }

        .markdown-body pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .markdown-body blockquote {
            border-left: 4px solid #667eea;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #4a5568;
            font-style: italic;
        }

        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .markdown-body th, .markdown-body td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            text-align: left;
        }

        .markdown-body th {
            background: #f7fafc;
            font-weight: bold;
        }

        /* „Çµ„Ç§„Éâ„Éê„Éº */
        .sidebar {
            position: fixed;
            left: -320px;
            top: 0;
            width: 320px;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a2e, #0f0f23);
            z-index: 200;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            box-shadow: 5px 0 30px rgba(0,0,0,0.5);
        }

        .sidebar.active {
            left: 0;
        }

        /* „Ç®„Éá„Ç£„Çø */
        .editor-input {
            width: 100%;
            padding: 0.75rem;
            font-size: 1.1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            transition: border-color 0.3s;
        }

        .editor-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .editor-textarea {
            width: 100%;
            min-height: 400px;
            padding: 1rem;
            font-size: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            resize: vertical;
            font-family: 'Monaco', 'Courier New', monospace;
            transition: border-color 0.3s;
        }

        .editor-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É™„Ç¢ */
        .image-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload-area:hover {
            border-color: #667eea;
            background: rgba(102,126,234,0.05);
        }

        .image-upload-area.dragging {
            border-color: #667eea;
            background: rgba(102,126,234,0.1);
        }

        /* „Éö„Éº„Ç∏„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .page-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding: 0 2rem;
        }

        .page-dots {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 300px;
        }

        .page-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-dot.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            transform: scale(1.5);
            box-shadow: 0 0 20px rgba(102,126,234,0.6);
        }

        /* ÈÄ≤Êçó„Éê„Éº */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
            z-index: 300;
        }

        /* „Éà„Éº„Çπ„ÉàÈÄöÁü• */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: #2d3748;
            padding: 1rem 2rem;
            border-radius: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 500;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* „Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 150;
            backdrop-filter: blur(5px);
        }

        .overlay.active {
            display: block;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 768px) {
            .page-content {
                padding: 2rem 1.5rem;
                border-radius: 0.5rem;
            }

            .action-cards {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .books-grid {
                grid-template-columns: 1fr;
            }

            .page-nav {
                padding: 0;
            }
        }

        /* „Ç¢„Ç§„Ç≥„É≥„Éú„Çø„É≥ */
        .icon-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            cursor: pointer;
            padding: 0.6rem;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        /* FirebaseË®≠ÂÆö„É¢„Éº„ÉÄ„É´ */
        .firebase-config-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 500px;
            width: 90%;
        }

        .firebase-config-modal.active {
            display: block;
        }

        .config-input {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
        }

        /* ÂÖ¨Èñã/ÈùûÂÖ¨Èñã„Éê„ÉÉ„Ç∏ */
        .visibility-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .visibility-badge.public {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .visibility-badge.private {
            background: #e2e8f0;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢ -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loader"></div>
    </div>

    <!-- ÈÄ≤Êçó„Éê„Éº -->
    <div id="progressBar" class="progress-bar" style="width: 0%;"></div>

    <!-- „Éõ„Éº„É†ÁîªÈù¢ -->
    <div id="homeView">
        <div class="header">
            <div class="logo">
                <span class="logo-icon">üìö</span>
                <span>StudyBook</span>
            </div>
            <div id="authSection">
                <button class="btn btn-primary" onclick="handleLogin()">
                    <span>üë§</span>
                    <span>Google„Åß„É≠„Ç∞„Ç§„É≥</span>
                </button>
            </div>
        </div>

        <div class="home-container">
            <div class="action-cards">
                <div class="action-card" onclick="createNewBook()">
                    <div class="action-card-icon">‚ú®</div>
                    <div class="action-card-title">Êñ∞Ë¶è‰ΩúÊàê</div>
                    <div style="color: #718096; margin-top: 0.5rem;">Â≠¶Áøí„Éé„Éº„Éà„Çí‰ΩúÊàê</div>
                </div>
                <div class="action-card" onclick="showPublicBooks()">
                    <div class="action-card-icon">üåç</div>
                    <div class="action-card-title">„Åø„Çì„Å™„ÅÆ„Éé„Éº„Éà</div>
                    <div style="color: #718096; margin-top: 0.5rem;">ÂÖ¨Èñã„Éé„Éº„Éà„ÇíÊé¢„Åô</div>
                </div>
                <div class="action-card" onclick="showToast('Ê§úÁ¥¢Ê©üËÉΩ„ÅØÊ∫ñÂÇô‰∏≠„Åß„Åô')">
                    <div class="action-card-icon">üîç</div>
                    <div class="action-card-title">Ê§úÁ¥¢</div>
                    <div style="color: #718096; margin-top: 0.5rem;">Coming Soon</div>
                </div>
            </div>

            <div id="myBooksSection" style="display: none;">
                <h2 style="color: white; font-size: 1.5rem; margin-bottom: 1.5rem;">üìñ „Éû„Ç§„Éé„Éº„Éà</h2>
                <div id="myBooksList" class="books-grid"></div>
            </div>

            <div id="publicBooksSection" style="display: none;">
                <h2 style="color: white; font-size: 1.5rem; margin-bottom: 1.5rem;">üåü „Åø„Çì„Å™„ÅÆ„Éé„Éº„Éà</h2>
                <div id="publicBooksList" class="books-grid"></div>
            </div>
        </div>
    </div>

    <!-- „Éì„É•„Éº„Ç¢„Éº/„Ç®„Éá„Ç£„Çø„ÉºÁîªÈù¢ -->
    <div id="viewerContainer" class="viewer-container">
        <div class="viewer-header">
            <div style="display: flex; gap: 0.5rem;">
                <button class="icon-btn" onclick="toggleSidebar()">‚ò∞</button>
                <button class="icon-btn" onclick="goHome()">üè†</button>
                <button id="saveBtn" class="icon-btn" onclick="saveBook()" style="display: none;">üíæ</button>
                <button id="addPageBtn" class="icon-btn" onclick="addPage()" style="display: none;">‚ûï</button>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button id="visibilityBtn" class="icon-btn" onclick="toggleVisibility()">üëÅÔ∏è</button>
                <button class="icon-btn" onclick="shareBook()">üîó</button>
                <span id="pageInfo" style="color: #a0aec0; margin-left: 1rem; font-size: 0.9rem;">„Éö„Éº„Ç∏ 1 / 1</span>
            </div>
        </div>

        <div id="sidebar" class="sidebar">
            <div style="padding: 1.5rem; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 1.25rem; font-weight: bold;">üìë ÁõÆÊ¨°</span>
                <button class="icon-btn" onclick="toggleSidebar()">‚úï</button>
            </div>
            <div id="tocList"></div>
        </div>

        <div class="page-container">
            <div class="page-wrapper">
                <div class="swipe-indicator left" id="swipeLeft">üëà</div>
                <div class="swipe-indicator right" id="swipeRight">üëâ</div>
                
                <div id="pageContent" class="page-content">
                    <div id="viewMode">
                        <h2 id="pageTitle" style="font-size: 2rem; font-weight: bold; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e2e8f0;"></h2>
                        <img id="pageImage" class="page-image" style="display: none;">
                        <div id="pageBody" class="markdown-body"></div>
                    </div>
                    <div id="editMode" style="display: none;">
                        <input type="text" id="pageTitleInput" class="editor-input" placeholder="„Éö„Éº„Ç∏„Çø„Ç§„Éà„É´">
                        <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageInput').click()">
                            <div>üì∑ ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</div>
                            <div style="font-size: 0.9rem; color: #718096; margin-top: 0.5rem;">„ÇØ„É™„ÉÉ„ÇØ„Åæ„Åü„ÅØ„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó</div>
                            <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        </div>
                        <div id="imagePreview" style="margin: 1rem 0;"></div>
                        <textarea id="pageContentInput" class="editor-textarea" placeholder="Markdown„ÅßÂÜÖÂÆπ„ÇíÂÖ•Âäõ

# Ë¶ãÂá∫„Åó1
## Ë¶ãÂá∫„Åó2
### Ë¶ãÂá∫„Åó3

**Â§™Â≠ó**„ÅÆ„ÉÜ„Ç≠„Çπ„Éà
*Êñú‰Ωì*„ÅÆ„ÉÜ„Ç≠„Çπ„Éà

- „É™„Çπ„ÉàÈ†ÖÁõÆ1
- „É™„Çπ„ÉàÈ†ÖÁõÆ2

1. Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà
2. Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà

> ÂºïÁî®Êñá

`„Ç≥„Éº„Éâ`

```
„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ
```

[„É™„É≥„ÇØ](https://example.com)
![ÁîªÂÉè](image.jpg)

| Ë°® | „Éò„ÉÉ„ÉÄ„Éº |
|-----|--------|
| „Éá„Éº„Çø | „Éá„Éº„Çø |"></textarea>
                    </div>
                </div>
            </div>

            <div class="page-nav">
                <button class="btn btn-primary" onclick="previousPage()" id="prevBtn">
                    ‚Üê Ââç„ÅÆ„Éö„Éº„Ç∏
                </button>
                <div id="pageDots" class="page-dots"></div>
                <button class="btn btn-primary" onclick="nextPage()" id="nextBtn">
                    Ê¨°„ÅÆ„Éö„Éº„Ç∏ ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- „Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>

    <!-- „Éà„Éº„Çπ„ÉàÈÄöÁü• -->
    <div id="toast" class="toast"></div>

    <!-- FirebaseË®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div id="firebaseConfigModal" class="firebase-config-modal">
        <h3>FirebaseË®≠ÂÆö</h3>
        <p style="font-size: 0.9rem; color: #718096; margin: 1rem 0;">Firebase„ÅÆË®≠ÂÆöÊÉÖÂ†±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
        <input type="text" id="apiKey" class="config-input" placeholder="API Key">
        <input type="text" id="authDomain" class="config-input" placeholder="Auth Domain">
        <input type="text" id="projectId" class="config-input" placeholder="Project ID">
        <input type="text" id="storageBucket" class="config-input" placeholder="Storage Bucket">
        <input type="text" id="messagingSenderId" class="config-input" placeholder="Messaging Sender ID">
        <input type="text" id="appId" class="config-input" placeholder="App ID">
        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="saveFirebaseConfig()">‰øùÂ≠ò</button>
            <button class="btn btn-secondary" onclick="closeFirebaseConfig()">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>

    <script>
        // ===== FirebaseË®≠ÂÆö =====
        // TODO: „Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆFirebaseË®≠ÂÆö„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // FirebaseÂàùÊúüÂåñ„Éï„É©„Ç∞
        let firebaseInitialized = false;
        let useLocalStorage = true; // Firebase„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Çí‰ΩøÁî®

        // FirebaseÂàùÊúüÂåñ„ÇíË©¶„Åø„Çã
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                firebaseInitialized = true;
                useLocalStorage = false;
                console.log("Firebase initialized successfully");
            }
        } catch (error) {
            console.log("Firebase not configured, using localStorage");
        }

        // ===== „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ =====
        let currentUser = null;
        let books = [];
        let currentBook = null;
        let currentPage = 0;
        let isEditing = false;
        let touchStartX = 0;
        let touchStartY = 0;
        let isSwiping = false;

        // ===== ÂàùÊúüÂåñ =====
        window.addEventListener('DOMContentLoaded', async function() {
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÇíÈùûË°®Á§∫
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 1000);

            // ÂàùÊúü„Éá„Éº„Çø„É≠„Éº„Éâ
            if (firebaseInitialized) {
                await initFirebase();
            } else {
                loadFromLocalStorage();
            }
            
            initializeSampleData();
            updateUI();
            
            // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà„ÅÆË®≠ÂÆö
            setupTouchEvents();
            
            // URL„Éë„É©„É°„Éº„Çø„ÉÅ„Çß„ÉÉ„ÇØ
            checkUrlParams();
        });

        // ===== FirebaseÂàùÊúüÂåñ =====
        async function initFirebase() {
            if (!firebaseInitialized) return;

            // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    currentUser = {
                        id: user.uid,
                        name: user.displayName || '„É¶„Éº„Ç∂„Éº',
                        email: user.email,
                        avatar: user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=667eea&color=fff`
                    };
                    loadBooksFromFirestore();
                } else {
                    currentUser = null;
                }
                updateUI();
            });
        }

        // ===== Firestore„Åã„Çâ„Éé„Éº„Éà„ÇíË™≠„ÅøËæº„Åø =====
        async function loadBooksFromFirestore() {
            if (!firebaseInitialized) return;

            try {
                const db = firebase.firestore();
                
                // Ëá™ÂàÜ„ÅÆ„Éé„Éº„Éà„ÇíÂèñÂæó
                const myBooksSnapshot = await db.collection('books')
                    .where('authorId', '==', currentUser.id)
                    .get();

                // ÂÖ¨Èñã„Éé„Éº„Éà„ÇíÂèñÂæó
                const publicBooksSnapshot = await db.collection('books')
                    .where('isPublic', '==', true)
                    .get();

                books = [];
                const bookIds = new Set();

                myBooksSnapshot.forEach(doc => {
                    const book = { id: doc.id, ...doc.data() };
                    books.push(book);
                    bookIds.add(doc.id);
                });

                publicBooksSnapshot.forEach(doc => {
                    if (!bookIds.has(doc.id)) {
                        const book = { id: doc.id, ...doc.data() };
                        books.push(book);
                    }
                });

                updateUI();
            } catch (error) {
                console.error('Error loading books:', error);
                showToast('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // ===== „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏Âá¶ÁêÜ =====
        function loadFromLocalStorage() {
            const savedUser = localStorage.getItem('studybook_user');
            const savedBooks = localStorage.getItem('studybook_books');
            const lastBookId = localStorage.getItem('studybook_lastBook');
            const lastPage = localStorage.getItem('studybook_lastPage');
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
            }
            
            if (savedBooks) {
                books = JSON.parse(savedBooks);
            }
            
            // ÈÄ≤ÊçóÂæ©ÂÖÉ
            if (lastBookId && lastPage !== null) {
                // Ëá™Âãï„ÅßÊúÄÂæå„Å´Èñã„ÅÑ„Å¶„ÅÑ„Åü„Éö„Éº„Ç∏„ÇíÈñã„ÅèÊ©üËÉΩÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
                // setTimeout(() => {
                //     openBook(lastBookId, false);
                //     currentPage = parseInt(lastPage);
                // }, 100);
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('studybook_books', JSON.stringify(books));
            if (currentUser) {
                localStorage.setItem('studybook_user', JSON.stringify(currentUser));
            }
            if (currentBook) {
                localStorage.setItem('studybook_lastBook', currentBook.id);
                localStorage.setItem('studybook_lastPage', currentPage);
            }
        }

        // ===== „Çµ„É≥„Éó„É´„Éá„Éº„Çø =====
        function initializeSampleData() {
            if (books.length === 0) {
                books = [
                    {
                        id: 'sample1',
                        title: 'üìö StudyBook„ÅÆ‰Ωø„ÅÑÊñπ',
                        author: 'StudyBookÂÖ¨Âºè',
                        authorId: 'system',
                        isPublic: true,
                        createdAt: new Date().toISOString(),
                        pages: [
                            {
                                title: '„Çà„ÅÜ„Åì„ÅùStudyBook„Å∏ÔºÅ',
                                content: `# StudyBook„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ üéâ

## StudyBook„Å®„ÅØÔºü
Â≠¶Áøí„Éé„Éº„Éà„Çí**ÈõªÂ≠ê„Éñ„ÉÉ„ÇØÂåñ**„Åó„Å¶ÂÖ±Êúâ„Åß„Åç„Çã„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†„Åß„Åô„ÄÇ

### ‰∏ª„Å™ÁâπÂæ¥
- üìù **Markdown**„ÅßÁæé„Åó„ÅÑ„Éé„Éº„Éà‰ΩúÊàê
- üì± **„Çπ„ÉØ„Ç§„ÉóÊìç‰Ωú**„Åß„Éö„Éº„Ç∏„ÇÅ„Åè„Çä
- üåç **ÂÖ¨Èñã/ÈùûÂÖ¨Èñã**„ÅÆÂàá„ÇäÊõø„Åà
- üîó **URL„Ç∑„Çß„Ç¢**Ê©üËÉΩ
- üì∏ **ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ**ÂØæÂøú

> Ê®™„Å´„Çπ„ÉØ„Ç§„Éó„Åó„Å¶„Éö„Éº„Ç∏„Çí„ÇÅ„Åè„Å£„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ`
                            },
                            {
                                title: 'Âü∫Êú¨ÁöÑ„Å™‰Ωø„ÅÑÊñπ',
                                content: `## Âü∫Êú¨Êìç‰Ωú„Ç¨„Ç§„Éâ

### „Éé„Éº„Éà„ÅÆ‰ΩúÊàê
1. „Éõ„Éº„É†ÁîªÈù¢„ÅÆ„Äå**Êñ∞Ë¶è‰ΩúÊàê**„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ
2. „Çø„Ç§„Éà„É´„Å®ÂÜÖÂÆπ„ÇíÂÖ•Âäõ
3. ‰øùÂ≠ò„Éú„Çø„É≥„Åß‰øùÂ≠ò

### „Éö„Éº„Ç∏„ÅÆÊìç‰Ωú
| Êìç‰Ωú | ÊñπÊ≥ï |
|------|------|
| Ê¨°„ÅÆ„Éö„Éº„Ç∏ | Â∑¶„Çπ„ÉØ„Ç§„Éó or Ê¨°„Å∏„Éú„Çø„É≥ |
| Ââç„ÅÆ„Éö„Éº„Ç∏ | Âè≥„Çπ„ÉØ„Ç§„Éó or Ââç„Å∏„Éú„Çø„É≥ |
| ÁõÆÊ¨°Ë°®Á§∫ | ‚ò∞„É°„Éã„É•„Éº„Éú„Çø„É≥ |

### MarkdownË®òÊ≥ï
\`\`\`markdown
# Ë¶ãÂá∫„Åó1
## Ë¶ãÂá∫„Åó2
**Â§™Â≠ó** *Êñú‰Ωì*
- „É™„Çπ„ÉàÈ†ÖÁõÆ
\`\`\`

Á∞°Âçò„Åß„Åó„Çá„ÅÜÔºü üòä`
                            },
                            {
                                title: 'È´òÂ∫¶„Å™Ê©üËÉΩ',
                                content: `## üöÄ È´òÂ∫¶„Å™Ê©üËÉΩ

### ÁîªÂÉè„ÅÆËøΩÂä†
Á∑®ÈõÜ„É¢„Éº„Éâ„ÅßÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åß„Åç„Åæ„ÅôÔºö
- „Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„ÉóÂØæÂøú
- Ëá™Âãï„É™„Çµ„Ç§„Ç∫
- Firebase Storage„Å´‰øùÂ≠ò

### „Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ
„Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞„Ç≥„Éº„Éâ„ÇÇÁæé„Åó„ÅèË°®Á§∫Ôºö

\`\`\`javascript
function hello() {
    console.log("Hello, StudyBook!");
}
\`\`\`

### Êï∞ÂºèË°®Á§∫Ôºà‰ªäÂæåÂÆüË£Ö‰∫àÂÆöÔºâ
LaTeXË®òÊ≥ï„ÅßÊï∞Âºè„ÇÇË°®Áèæ„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çã‰∫àÂÆö„Åß„Åô„ÄÇ

### ÂÖ±ÂêåÁ∑®ÈõÜÔºà‰ªäÂæåÂÆüË£Ö‰∫àÂÆöÔºâ
Ë§áÊï∞‰∫∫„Åß„ÅÆÂêåÊôÇÁ∑®ÈõÜÊ©üËÉΩ„ÇÇÊ§úË®é‰∏≠„Åß„ÅôÔºÅ

---

**StudyBook„ÅßÁ¥†Êïµ„Å™Â≠¶Áøí‰ΩìÈ®ì„ÇíÔºÅ** ‚ú®`
                            }
                        ]
                    },
                    {
                        id: 'sample2',
                        title: 'Ë°åÊîøÊõ∏Â£´Ë©¶È®ìÂØæÁ≠ñ„Éé„Éº„Éà',
                        author: '„Çµ„É≥„Éó„É´Ë¨õÂ∏´',
                        authorId: 'sample',
                        isPublic: true,
                        createdAt: new Date().toISOString(),
                        pages: [
                            {
                                title: 'ÊÜ≤Ê≥ï - Âü∫Êú¨ÂéüÁêÜ',
                                content: `# ÊÜ≤Ê≥ï„ÅÆÂü∫Êú¨ÂéüÁêÜ

## ‰∏âÂ§ßÂéüÁêÜ
1. **ÂõΩÊ∞ë‰∏ªÊ®©** - ‰∏ªÊ®©„ÅØÂõΩÊ∞ë„Å´„ÅÇ„Çã
2. **Âü∫Êú¨ÁöÑ‰∫∫Ê®©„ÅÆÂ∞äÈáç** - ‰∫∫Ê®©„ÅÆ‰øùÈöú
3. **Âπ≥Âíå‰∏ªÁæ©** - Êà¶‰∫âÊîæÊ£Ñ„ÉªÊà¶Âäõ‰∏ç‰øùÊåÅ

## ÈáçË¶ÅÂà§‰æã
### „Éû„ÇØ„É™„Éº„É≥‰∫ã‰ª∂ÔºàÊúÄÂà§Êò≠53.10.4Ôºâ
> Â§ñÂõΩ‰∫∫„ÅÆ‰∫∫Ê®©‰øùÈöú„ÅÆÁØÑÂõ≤„Å´„Å§„ÅÑ„Å¶Âà§Á§∫

### ‰∏âËè±Ê®πËÑÇ‰∫ã‰ª∂ÔºàÊúÄÂà§Êò≠48.12.12Ôºâ
> ÁßÅ‰∫∫ÈñìÂäπÂäõ„Å´„Å§„ÅÑ„Å¶ÈáçË¶Å„Å™Âà§Êñ≠

---
*Ê¨°„ÅÆ„Éö„Éº„Ç∏„ÅßË©≥Á¥∞„ÇíËß£Ë™¨„Åó„Åæ„Åô*`
                            }
                        ]
                    }
                ];
                saveToLocalStorage();
            }
        }

        // ===== „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ =====
        async function handleLogin() {
            if (firebaseInitialized) {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    const result = await firebase.auth().signInWithPopup(provider);
                    currentUser = {
                        id: result.user.uid,
                        name: result.user.displayName,
                        email: result.user.email,
                        avatar: result.user.photoURL || `https://ui-avatars.com/api/?name=${result.user.displayName}&background=667eea&color=fff`
                    };
                    showToast('„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„ÅüÔºÅ');
                    await loadBooksFromFirestore();
                } catch (error) {
                    console.error('Login error:', error);
                    showToast('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } else {
                // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„É¢„Éº„Éâ
                currentUser = {
                    id: 'user_' + Date.now(),
                    name: '„É≠„Éº„Ç´„É´„É¶„Éº„Ç∂„Éº',
                    email: 'local@example.com',
                    avatar: 'https://ui-avatars.com/api/?name=Local+User&background=667eea&color=fff'
                };
                saveToLocalStorage();
                showToast('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åß„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü');
            }
            updateUI();
        }

        // ===== „É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ =====
        async function handleLogout() {
            if (firebaseInitialized) {
                await firebase.auth().signOut();
            }
            currentUser = null;
            localStorage.removeItem('studybook_user');
            showToast('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü');
            updateUI();
        }

        // ===== UIÊõ¥Êñ∞ =====
        function updateUI() {
            updateAuthSection();
            updateMyBooks();
            updatePublicBooks();
            updateProgressBar();
        }

        function updateAuthSection() {
            const authSection = document.getElementById('authSection');
            if (currentUser) {
                authSection.innerHTML = `
                    <div class="user-info">
                        <img src="${currentUser.avatar}" alt="${currentUser.name}" class="user-avatar">
                        <span style="color: white; font-weight: 600;">${currentUser.name}</span>
                        <button class="btn btn-secondary" onclick="handleLogout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                    </div>
                `;
                document.getElementById('myBooksSection').style.display = 'block';
            } else {
                authSection.innerHTML = `
                    <button class="btn btn-primary" onclick="handleLogin()">
                        <span>üë§</span>
                        <span>Google„Åß„É≠„Ç∞„Ç§„É≥</span>
                    </button>
                `;
                document.getElementById('myBooksSection').style.display = 'none';
            }
        }

        function updateMyBooks() {
            if (!currentUser) return;
            
            const myBooks = books.filter(b => b.authorId === currentUser.id);
            const listEl = document.getElementById('myBooksList');
            
            if (myBooks.length === 0) {
                listEl.innerHTML = '<p style="color: white; text-align: center;">„Åæ„Å†„Éé„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊñ∞Ë¶è‰ΩúÊàê„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p>';
                return;
            }
            
            listEl.innerHTML = myBooks.map(book => `
                <div class="book-card">
                    <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">${book.title}</div>
                    <div style="color: #718096; margin-bottom: 0.25rem;">üìù ${book.pages.length} „Éö„Éº„Ç∏</div>
                    <div style="color: #718096; margin-bottom: 0.75rem;">üìÖ ${new Date(book.createdAt).toLocaleDateString()}</div>
                    <div class="visibility-badge ${book.isPublic ? 'public' : 'private'}">
                        ${book.isPublic ? 'üåç ÂÖ¨Èñã' : 'üîí ÈùûÂÖ¨Èñã'}
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="openBook('${book.id}', false)" style="flex: 1;">Èñã„Åè</button>
                        <button class="btn btn-secondary" onclick="openBook('${book.id}', true)" style="flex: 1;">Á∑®ÈõÜ</button>
                    </div>
                </div>
            `).join('');
        }

        function updatePublicBooks() {
            const publicBooks = books.filter(b => b.isPublic);
            const listEl = document.getElementById('publicBooksList');
            
            if (publicBooks.length === 0) {
                listEl.innerHTML = '<p style="color: white; text-align: center;">ÂÖ¨Èñã„Åï„Çå„Å¶„ÅÑ„Çã„Éé„Éº„Éà„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            listEl.innerHTML = publicBooks.map(book => `
                <div class="book-card">
                    <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">${book.title}</div>
                    <div style="color: #718096; margin-bottom: 0.25rem;">üë§ ${book.author}</div>
                    <div style="color: #718096; margin-bottom: 0.25rem;">üìù ${book.pages.length} „Éö„Éº„Ç∏</div>
                    <div style="color: #718096; margin-bottom: 1rem;">üìÖ ${new Date(book.createdAt).toLocaleDateString()}</div>
                    <button class="btn btn-primary" onclick="openBook('${book.id}', false)" style="width: 100%;">
                        Ë™≠„ÇÄ
                    </button>
                </div>
            `).join('');
        }

        // ===== „Éé„Éº„Éà‰ΩúÊàê =====
        async function createNewBook() {
            if (!currentUser) {
                showToast('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            const newBook = {
                id: 'book_' + Date.now(),
                title: 'Êñ∞„Åó„ÅÑ„Éé„Éº„Éà',
                author: currentUser.name,
                authorId: currentUser.id,
                isPublic: false,
                createdAt: new Date().toISOString(),
                pages: [
                    {
                        title: '„Çø„Ç§„Éà„É´„Éö„Éº„Ç∏',
                        content: '# Êñ∞„Åó„ÅÑ„Éé„Éº„Éà\n\nÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                        image: null
                    }
                ]
            };
            
            if (firebaseInitialized) {
                try {
                    const db = firebase.firestore();
                    const docRef = await db.collection('books').add(newBook);
                    newBook.id = docRef.id;
                } catch (error) {
                    console.error('Error creating book:', error);
                }
            }
            
            books.push(newBook);
            saveToLocalStorage();
            openBook(newBook.id, true);
        }

        // ===== „Éé„Éº„Éà„ÇíÈñã„Åè =====
        function openBook(bookId, editMode) {
            currentBook = books.find(b => b.id === bookId);
            if (!currentBook) {
                showToast('„Éé„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            currentPage = 0;
            isEditing = editMode && currentUser && currentBook.authorId === currentUser.id;
            
            document.getElementById('homeView').style.display = 'none';
            document.getElementById('viewerContainer').style.display = 'block';
            
            updateViewer();
            saveToLocalStorage(); // ÈÄ≤Êçó‰øùÂ≠ò
        }

        // ===== „Éì„É•„Éº„Ç¢„ÉºÊõ¥Êñ∞ =====
        function updateViewer() {
            if (!currentBook) return;
            
            document.getElementById('saveBtn').style.display = isEditing ? 'inline-block' : 'none';
            document.getElementById('addPageBtn').style.display = isEditing ? 'inline-block' : 'none';
            document.getElementById('pageInfo').textContent = `„Éö„Éº„Ç∏ ${currentPage + 1} / ${currentBook.pages.length}`;
            document.getElementById('visibilityBtn').textContent = currentBook.isPublic ? 'üåç' : 'üîí';
            
            updateTOC();
            updatePageContent();
            updatePageNavigation();
            updateProgressBar();
        }

        // ===== ÁõÆÊ¨°Êõ¥Êñ∞ =====
        function updateTOC() {
            const tocList = document.getElementById('tocList');
            tocList.innerHTML = currentBook.pages.map((page, index) => `
                <div style="padding: 1rem 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: ${index === currentPage ? 'rgba(102,126,234,0.2)' : 'transparent'}; border-left: ${index === currentPage ? '3px solid #667eea' : 'none'}; transition: all 0.3s;" onclick="goToPage(${index})" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='${index === currentPage ? 'rgba(102,126,234,0.2)' : 'transparent'}'">
                    <span>${page.title}</span>
                    ${isEditing && currentBook.pages.length > 1 ? `
                        <button class="icon-btn" onclick="deletePage(${index}, event)" style="background: rgba(239,68,68,0.2); color: #ef4444;">üóëÔ∏è</button>
                    ` : ''}
                </div>
            `).join('');
        }

        // ===== „Éö„Éº„Ç∏ÂÜÖÂÆπÊõ¥Êñ∞ =====
        function updatePageContent() {
            const page = currentBook.pages[currentPage];
            
            if (isEditing) {
                document.getElementById('viewMode').style.display = 'none';
                document.getElementById('editMode').style.display = 'block';
                
                document.getElementById('pageTitleInput').value = page.title;
                document.getElementById('pageContentInput').value = page.content;
                
                if (page.image) {
                    document.getElementById('imagePreview').innerHTML = `
                        <img src="${page.image}" style="max-width: 100%; max-height: 300px; border-radius: 0.5rem;">
                        <button class="btn btn-danger" onclick="removeImage()" style="margin-top: 0.5rem;">ÁîªÂÉè„ÇíÂâäÈô§</button>
                    `;
                } else {
                    document.getElementById('imagePreview').innerHTML = '';
                }
            } else {
                document.getElementById('viewMode').style.display = 'block';
                document.getElementById('editMode').style.display = 'none';
                
                document.getElementById('pageTitle').textContent = page.title;
                
                // ÁîªÂÉèË°®Á§∫
                if (page.image) {
                    document.getElementById('pageImage').src = page.image;
                    document.getElementById('pageImage').style.display = 'block';
                } else {
                    document.getElementById('pageImage').style.display = 'none';
                }
                
                // Marked.js„ÅßMarkdown„Çí„Éë„Éº„Çπ
                document.getElementById('pageBody').innerHTML = marked.parse(page.content || '');
            }
        }

        // ===== „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàË®≠ÂÆö =====
        function setupTouchEvents() {
            const pageContent = document.getElementById('pageContent');
            if (!pageContent) return;

            pageContent.addEventListener('touchstart', handleTouchStart, { passive: true });
            pageContent.addEventListener('touchmove', handleTouchMove, { passive: true });
            pageContent.addEventListener('touchend', handleTouchEnd);
        }

        function handleTouchStart(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            isSwiping = false;
        }

        function handleTouchMove(e) {
            if (!touchStartX || !touchStartY) return;

            const touchEndX = e.touches[0].clientX;
            const touchEndY = e.touches[0].clientY;

            const deltaX = touchStartX - touchEndX;
            const deltaY = touchStartY - touchEndY;

            // Ê®™„Çπ„ÉØ„Ç§„Éó„ÅÆÂà§ÂÆöÔºàÁ∏¶„Çπ„ÉØ„Ç§„Éó„Çà„ÇäÊ®™„Çπ„ÉØ„Ç§„Éó„ÅåÂ§ß„Åç„ÅÑÂ†¥ÂêàÔºâ
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 30) {
                isSwiping = true;
                
                // „Çπ„ÉØ„Ç§„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË°®Á§∫
                if (deltaX > 0 && currentPage < currentBook.pages.length - 1) {
                    document.getElementById('swipeRight').classList.add('active');
                    document.getElementById('pageContent').classList.add('swipe-left');
                } else if (deltaX < 0 && currentPage > 0) {
                    document.getElementById('swipeLeft').classList.add('active');
                    document.getElementById('pageContent').classList.add('swipe-right');
                }
            }
        }

        function handleTouchEnd(e) {
            if (!touchStartX || !isSwiping) return;

            const touchEndX = e.changedTouches[0].clientX;
            const deltaX = touchStartX - touchEndX;

            // „Çπ„ÉØ„Ç§„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÈùûË°®Á§∫
            document.getElementById('swipeLeft').classList.remove('active');
            document.getElementById('swipeRight').classList.remove('active');
            document.getElementById('pageContent').classList.remove('swipe-left', 'swipe-right');

            // „Çπ„ÉØ„Ç§„ÉóÂà§ÂÆöÔºà50px‰ª•‰∏ä„Çπ„ÉØ„Ç§„Éó„Åó„ÅüÂ†¥ÂêàÔºâ
            if (Math.abs(deltaX) > 50) {
                if (deltaX > 0) {
                    // Â∑¶„Çπ„ÉØ„Ç§„Éó ‚Üí Ê¨°„ÅÆ„Éö„Éº„Ç∏
                    nextPage();
                } else {
                    // Âè≥„Çπ„ÉØ„Ç§„Éó ‚Üí Ââç„ÅÆ„Éö„Éº„Ç∏
                    previousPage();
                }
            }

            touchStartX = 0;
            touchStartY = 0;
        }

        // ===== „Éö„Éº„Ç∏„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ =====
        function updatePageNavigation() {
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = currentPage === currentBook.pages.length - 1;
            
            const dotsContainer = document.getElementById('pageDots');
            dotsContainer.innerHTML = currentBook.pages.map((_, index) => `
                <button class="page-dot ${index === currentPage ? 'active' : ''}" onclick="goToPage(${index})"></button>
            `).join('');
        }

        function goToPage(pageIndex) {
            if (isEditing) {
                saveCurrentPage();
            }
            
            currentPage = pageIndex;
            
            // „Éö„Éº„Ç∏„Éï„É™„ÉÉ„Éó„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            const pageContent = document.getElementById('pageContent');
            pageContent.classList.add('page-flip');
            setTimeout(() => {
                updateViewer();
                pageContent.classList.remove('page-flip');
            }, 300);
            
            closeSidebar();
            saveToLocalStorage(); // ÈÄ≤Êçó‰øùÂ≠ò
        }

        function previousPage() {
            if (currentPage > 0) {
                goToPage(currentPage - 1);
            }
        }

        function nextPage() {
            if (currentPage < currentBook.pages.length - 1) {
                goToPage(currentPage + 1);
            }
        }

        // ===== „Éö„Éº„Ç∏ËøΩÂä†/ÂâäÈô§ =====
        function addPage() {
            if (!isEditing) return;
            
            saveCurrentPage();
            
            currentBook.pages.push({
                title: `„Éö„Éº„Ç∏${currentBook.pages.length + 1}`,
                content: '',
                image: null
            });
            
            currentPage = currentBook.pages.length - 1;
            updateViewer();
            showToast('Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
        }

        function deletePage(index, event) {
            if (event) event.stopPropagation();
            if (!isEditing || currentBook.pages.length <= 1) return;
            
            if (confirm('„Åì„ÅÆ„Éö„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                currentBook.pages.splice(index, 1);
                if (currentPage >= currentBook.pages.length) {
                    currentPage = currentBook.pages.length - 1;
                }
                updateViewer();
                showToast('„Éö„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
            }
        }

        // ===== ÁîªÂÉèÂá¶ÁêÜ =====
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showToast('ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            try {
                let imageUrl;
                
                if (firebaseInitialized) {
                    // Firebase Storage„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                    const storage = firebase.storage();
                    const storageRef = storage.ref();
                    const imageRef = storageRef.child(`images/${currentUser.id}/${Date.now()}_${file.name}`);
                    
                    const snapshot = await imageRef.put(file);
                    imageUrl = await snapshot.ref.getDownloadURL();
                } else {
                    // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„É¢„Éº„ÉâÔºàBase64„Ç®„É≥„Ç≥„Éº„ÉâÔºâ
                    imageUrl = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                }

                // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
                document.getElementById('imagePreview').innerHTML = `
                    <img src="${imageUrl}" style="max-width: 100%; max-height: 300px; border-radius: 0.5rem;">
                    <button class="btn btn-danger" onclick="removeImage()" style="margin-top: 0.5rem;">ÁîªÂÉè„ÇíÂâäÈô§</button>
                `;

                // ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„Å´ÁîªÂÉèURL„Çí‰øùÂ≠ò
                currentBook.pages[currentPage].image = imageUrl;
                
                showToast('ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('Image upload error:', error);
                showToast('ÁîªÂÉè„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function removeImage() {
            currentBook.pages[currentPage].image = null;
            document.getElementById('imagePreview').innerHTML = '';
            showToast('ÁîªÂÉè„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
        }

        // ===== „Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó =====
        const imageUploadArea = document.getElementById('imageUploadArea');
        if (imageUploadArea) {
            imageUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                imageUploadArea.classList.add('dragging');
            });

            imageUploadArea.addEventListener('dragleave', () => {
                imageUploadArea.classList.remove('dragging');
            });

            imageUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                imageUploadArea.classList.remove('dragging');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('imageInput').files = files;
                    handleImageUpload({ target: { files: files } });
                }
            });
        }

        // ===== ‰øùÂ≠òÂá¶ÁêÜ =====
        function saveCurrentPage() {
            if (!isEditing) return;
            
            const page = currentBook.pages[currentPage];
            page.title = document.getElementById('pageTitleInput').value || '„Éö„Éº„Ç∏' + (currentPage + 1);
            page.content = document.getElementById('pageContentInput').value;
        }

        async function saveBook() {
            if (!isEditing) return;
            
            saveCurrentPage();
            
            // „Çø„Ç§„Éà„É´„ÇíÊúÄÂàù„ÅÆ„Éö„Éº„Ç∏„Åã„ÇâÂèñÂæó
            if (currentBook.pages.length > 0 && currentBook.pages[0].title) {
                currentBook.title = currentBook.pages[0].title;
            }
            
            currentBook.updatedAt = new Date().toISOString();
            
            if (firebaseInitialized) {
                try {
                    const db = firebase.firestore();
                    await db.collection('books').doc(currentBook.id).set(currentBook);
                    showToast('‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅÔºà„ÇØ„É©„Ç¶„ÉâÔºâ');
                } catch (error) {
                    console.error('Save error:', error);
                    showToast('„ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    saveToLocalStorage();
                }
            } else {
                saveToLocalStorage();
                showToast('‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅÔºà„É≠„Éº„Ç´„É´Ôºâ');
            }
            
            updateUI();
        }

        // ===== ÂÖ¨Èñã/ÈùûÂÖ¨ÈñãÂàá„ÇäÊõø„Åà =====
        async function toggleVisibility() {
            if (!currentUser || currentBook.authorId !== currentUser.id) {
                showToast('Ëá™ÂàÜ„ÅÆ„Éé„Éº„Éà„ÅÆ„ÅøÂÖ¨ÈñãË®≠ÂÆö„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô');
                return;
            }
            
            currentBook.isPublic = !currentBook.isPublic;
            
            if (firebaseInitialized) {
                try {
                    const db = firebase.firestore();
                    await db.collection('books').doc(currentBook.id).update({
                        isPublic: currentBook.isPublic
                    });
                } catch (error) {
                    console.error('Visibility update error:', error);
                }
            }
            
            saveToLocalStorage();
            updateViewer();
            showToast(currentBook.isPublic ? '„Éé„Éº„Éà„ÇíÂÖ¨Èñã„Åó„Åæ„Åó„Åü' : '„Éé„Éº„Éà„ÇíÈùûÂÖ¨Èñã„Å´„Åó„Åæ„Åó„Åü');
        }

        // ===== „Ç∑„Çß„Ç¢Ê©üËÉΩ =====
        async function shareBook() {
            if (!currentBook) return;
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?book=${currentBook.id}`;
            
            try {
                // Web Share API„ÇíË©¶„Åô
                if (navigator.share) {
                    await navigator.share({
                        title: currentBook.title,
                        text: `StudyBook„Åß„Äå${currentBook.title}„Äç„ÇíË™≠„ÇÇ„ÅÜÔºÅ`,
                        url: shareUrl
                    });
                } else {
                    // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
                    await navigator.clipboard.writeText(shareUrl);
                    showToast('„Ç∑„Çß„Ç¢URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
                }
            } catch (error) {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                const tempInput = document.createElement('input');
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showToast('„Ç∑„Çß„Ç¢URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
            }
        }

        // ===== „Çµ„Ç§„Éâ„Éê„ÉºÂà∂Âæ° =====
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }

        // ===== „Éõ„Éº„É†„Å´Êàª„Çã =====
        function goHome() {
            if (isEditing) {
                if (confirm('Â§âÊõ¥„Çí‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü')) {
                    saveBook();
                }
            }
            
            document.getElementById('homeView').style.display = 'block';
            document.getElementById('viewerContainer').style.display = 'none';
            currentBook = null;
            currentPage = 0;
            isEditing = false;
            updateUI();
        }

        // ===== „Åø„Çì„Å™„ÅÆ„Éé„Éº„ÉàË°®Á§∫ =====
        function showPublicBooks() {
            document.getElementById('publicBooksSection').style.display = 'block';
            
            // „Çπ„ÇØ„É≠„Éº„É´
            document.getElementById('publicBooksSection').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        // ===== „Éà„Éº„Çπ„ÉàÈÄöÁü• =====
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ===== ÈÄ≤Êçó„Éê„ÉºÊõ¥Êñ∞ =====
        function updateProgressBar() {
            if (currentBook && currentBook.pages.length > 0) {
                const progress = ((currentPage + 1) / currentBook.pages.length) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
            } else {
                document.getElementById('progressBar').style.width = '0%';
            }
        }

        // ===== URL„Éë„É©„É°„Éº„Çø„ÉÅ„Çß„ÉÉ„ÇØ =====
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get('book');
            
            if (bookId) {
                const book = books.find(b => b.id === bookId);
                if (book && book.isPublic) {
                    setTimeout(() => {
                        openBook(bookId, false);
                    }, 1500);
                }
            }
        }

        // ===== FirebaseË®≠ÂÆöÈñ¢ÈÄ£ =====
        function showFirebaseConfig() {
            document.getElementById('firebaseConfigModal').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        function closeFirebaseConfig() {
            document.getElementById('firebaseConfigModal').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }

        function saveFirebaseConfig() {
            const config = {
                apiKey: document.getElementById('apiKey').value,
                authDomain: document.getElementById('authDomain').value,
                projectId: document.getElementById('projectId').value,
                storageBucket: document.getElementById('storageBucket').value,
                messagingSenderId: document.getElementById('messagingSenderId').value,
                appId: document.getElementById('appId').value
            };
            
            // LocalStorage„Å´‰øùÂ≠ò
            localStorage.setItem('firebase_config', JSON.stringify(config));
            
            showToast('FirebaseË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            closeFirebaseConfig();
            
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    </script>
</body>
</html>
