<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <meta name="description" content="StudyBook - 学習ノートを電子ブック化して共有できるプラットフォーム">
    <meta name="keywords" content="学習,ノート,電子書籍,共有,StudyBook">
    <meta property="og:title" content="StudyBook - 学習ノート共有プラットフォーム">
    <meta property="og:description" content="学習ノートを美しい電子ブックに変換して共有しよう">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
    
    <!-- PWA対応 -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#333333">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <title>StudyBook - 学習ノート共有プラットフォーム</title>
    
    <!-- 外部CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 接続状態インジケーター -->
    <div id="connectionStatus" class="connection-status">
        <span id="connectionText">オフライン</span>
    </div>

    <!-- ローディング画面 -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loader"></div>
        <div class="loading-text" id="loadingText">読み込み中...</div>
    </div>

    <!-- 認証モーダル -->
    <div id="authModal" class="auth-modal">
        <div class="auth-form">
            <h2 id="authFormTitle">ログイン</h2>
            
            <!-- Googleログインボタン -->
            <button type="button" class="btn-google" onclick="app.handleGoogleLogin()">
                <svg viewBox="0 0 24 24">
                    <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Googleでログイン
            </button>
            
            <div class="auth-divider">
                <span>または</span>
            </div>
            
            <form id="authForm" onsubmit="app.handleAuthSubmit(event)" autocomplete="on">
                <div class="form-group">
                    <label class="form-label">メールアドレス</label>
                    <input 
                        type="email" 
                        id="emailInput" 
                        class="form-input" 
                        required
                        autocomplete="username email"
                        placeholder="example@email.com"
                    >
                    <div id="emailError" class="form-error"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">パスワード</label>
                    <input 
                        type="password" 
                        id="passwordInput" 
                        class="form-input" 
                        required
                        autocomplete="current-password"
                        placeholder="6文字以上"
                        minlength="6"
                    >
                    <div id="passwordError" class="form-error"></div>
                </div>
                
                <button type="submit" class="btn-filled" style="width: 100%;">
                    <span id="authSubmitText">ログイン</span>
                </button>
            </form>
            
            <div class="auth-toggle">
                <span id="authToggleText">アカウントをお持ちでない方は</span>
                <a onclick="app.toggleAuthMode(event)" id="authToggleLink">新規登録</a>
            </div>
            
            <div style="text-align: center; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="app.closeAuthModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- ホーム画面 -->
    <div id="homeView">
        <header class="header">
            <a href="/" class="logo" aria-label="StudyBook ホーム">
                <span>📚</span>
                <span>StudyBook</span>
            </a>
            
            <div class="search-container">
                <input 
                    type="search" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="ノートを検索..."
                    aria-label="ノートを検索"
                    maxlength="100"
                    autocomplete="off"
                >
                <span class="search-icon">🔍</span>
                <div id="searchResults" class="search-results"></div>
            </div>

            <div id="authSection">
                <button class="btn btn-primary" onclick="app.showAuthModal()" aria-label="ログイン" title="ログイン">
                    👤
                </button>
            </div>
        </header>

        <main style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">
            <!-- 続きから読む -->
            <div id="continueReading" style="display: none;"></div>

            <!-- アクションカード -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
                <div class="book-card" onclick="app.createNewBook()" role="button" tabindex="0">
                    <div style="font-size: 2rem; text-align: center; margin-bottom: 1rem;">📝</div>
                    <h3 style="font-size: 1rem; text-align: center; margin-bottom: 0.5rem;">新規作成</h3>
                    <p style="color: var(--text-secondary); text-align: center; font-size: 0.9rem;">学習ノートを作成</p>
                </div>
                
                <div class="book-card" onclick="app.showPublicBooks()" role="button" tabindex="0">
                    <div style="font-size: 2rem; text-align: center; margin-bottom: 1rem;">📚</div>
                    <h3 style="font-size: 1rem; text-align: center; margin-bottom: 0.5rem;">みんなのノート</h3>
                    <p style="color: var(--text-secondary); text-align: center; font-size: 0.9rem;">公開ノートを探す</p>
                </div>
                
                <div class="book-card" onclick="app.showPopularTags()" role="button" tabindex="0">
                    <div style="font-size: 2rem; text-align: center; margin-bottom: 1rem;">🏷️</div>
                    <h3 style="font-size: 1rem; text-align: center; margin-bottom: 0.5rem;">人気のタグ</h3>
                    <p style="color: var(--text-secondary); text-align: center; font-size: 0.9rem;">タグから探す</p>
                </div>
            </div>

            <!-- マイノート（本棚UI） -->
            <section id="myBooksSection" style="display: none;">
                <h2 style="color: var(--text-primary); font-size: 1.25rem; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
                    📚 マイライブラリ
                </h2>
                
                <!-- 表示切り替え -->
                <div class="shelf-toggle">
                    <button id="shelfViewBtn" class="active" onclick="app.setViewMode('shelf')">
                        📚 本棚表示
                    </button>
                    <button id="gridViewBtn" onclick="app.setViewMode('grid')">
                        📋 グリッド表示
                    </button>
                </div>
                
                <!-- 本棚表示 -->
                <div id="bookshelfView" class="bookshelf-container">
                    <div id="myBookshelf" class="bookshelf"></div>
                </div>
                
                <!-- グリッド表示 -->
                <div id="gridView" style="display: none;">
                    <div id="myBooksList" class="books-grid"></div>
                </div>
            </section>

            <!-- みんなのノート -->
            <section id="publicBooksSection" style="display: none; margin-top: 3rem;">
                <h2 style="color: var(--text-primary); font-size: 1.25rem; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">みんなのノート</h2>
                <div id="publicBooksList" class="books-grid"></div>
            </section>

            <!-- 人気タグ -->
            <section id="popularTagsSection" style="display: none; margin-top: 3rem;">
                <h2 style="color: var(--text-primary); font-size: 1.25rem; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">人気のタグ</h2>
                <div id="popularTagsList" class="tags-container" style="background: var(--bg-secondary); padding: 2rem; border: 1px solid var(--border-color); border-radius: 8px;"></div>
            </section>
        </main>
    </div>

    <!-- ビューアー/エディター画面 -->
    <div id="viewerContainer" class="viewer-container">
        <!-- ヘッダー -->
        <header class="viewer-header">
            <div class="header-group">
                <button class="btn btn-secondary" onclick="app.toggleSidebar()" aria-label="メニュー" title="目次">☰</button>
                <button class="btn btn-secondary" onclick="app.goHome()" aria-label="ホーム" title="ホーム">🏠</button>
                <button id="saveBtn" class="btn btn-success" onclick="app.saveBook()" style="display: none;" aria-label="保存" title="保存">💾</button>
                <button id="addPageBtn" class="btn btn-primary" onclick="app.addPage()" style="display: none;" aria-label="ページ追加" title="ページ追加">➕</button>
                <button id="deleteBookBtn" class="btn btn-danger" onclick="app.deleteBook()" style="display: none;" aria-label="ノート削除" title="ノート削除">🗑️</button>
            </div>
            
            <span id="pageInfo" class="page-info">1 / 1</span>
            
            <div class="header-group">
                <button id="visibilityBtn" class="btn btn-secondary" onclick="app.showVisibilitySettings()" aria-label="公開設定" title="公開設定">👁️</button>
                <button class="btn btn-primary" onclick="app.showShareModal()" aria-label="シェア" title="シェア">🔗</button>
            </div>
        </header>

        <!-- サイドバー -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h2 style="font-size: 1rem; font-weight: 600;">📑 目次</h2>
                <button class="btn btn-secondary" onclick="app.toggleSidebar()" aria-label="閉じる">✕</button>
            </div>
            <nav id="tocList" aria-label="目次"></nav>
        </aside>

        <!-- メインコンテンツ -->
        <main>
            <div id="pageContent" class="page-content">
                <!-- スワイプヒント（モバイル用） -->
                <div class="swipe-hint" id="swipeHint">← 左右にスワイプでページ移動 →</div>
                
                <div class="page-content-wrapper" id="pageContentWrapper">
                    <div id="viewMode">
                        <h1 id="pageTitle" style="font-size: 1.75rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border-color);"></h1>
                        <img id="pageImage" style="display: none;" alt="ページ画像">
                        <div id="pageBody" class="markdown-body"></div>
                    </div>
                    
                    <div id="editMode" style="display: none;">
                        <!-- ノートタイトル編集 -->
                        <div id="bookTitleSection" class="book-title-section" style="display: none;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">ノートタイトル</label>
                            <input 
                                type="text" 
                                id="bookTitleInput" 
                                class="form-input"
                                placeholder="ノートのタイトル"
                                maxlength="100"
                            >
                        </div>

                        <input 
                            type="text" 
                            id="pageTitleInput" 
                            class="form-input"
                            style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;"
                            placeholder="ページタイトル"
                            maxlength="100"
                        >
                        
                        <div style="border: 2px dashed var(--border-color); border-radius: 6px; padding: 2rem; text-align: center; margin: 1rem 0; cursor: pointer; transition: var(--transition-base); background: var(--bg-color);" 
                             onclick="document.getElementById('imageInput').click()"
                             ondragover="event.preventDefault(); this.style.borderColor='var(--primary-color)'"
                             ondragleave="this.style.borderColor='var(--border-color)'"
                             ondrop="app.handleDrop(event)">
                            <div style="font-size: 1rem;">📷 画像をアップロード</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">クリック or ドラッグ&ドロップ（最大5MB）</div>
                            <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="app.handleImageUpload(event)">
                        </div>
                        
                        <div id="imagePreview" style="margin: 1rem 0;"></div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem;">タグ（カンマ区切り）</label>
                            <input 
                                type="text" 
                                id="pageTagsInput" 
                                class="form-input"
                                placeholder="例: 数学, 微分積分, 大学"
                                maxlength="200"
                            >
                        </div>

                        <!-- エディターツールバー -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-color); border-radius: 6px; border: 1px solid var(--border-color);">
                            <button class="btn btn-secondary" onclick="app.insertImageInContent()" title="画像を挿入" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                📷 画像挿入
                            </button>
                            <button class="btn btn-secondary" onclick="app.insertMarkdown('**', '**')" title="太字" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                <strong>B</strong>
                            </button>
                            <button class="btn btn-secondary" onclick="app.insertMarkdown('*', '*')" title="斜体" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                <em>I</em>
                            </button>
                            <button class="btn btn-secondary" onclick="app.insertMarkdown('`', '`')" title="コード" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                &lt;&gt;
                            </button>
                            <button class="btn btn-secondary" onclick="app.insertMarkdown('## ', '')" title="見出し" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                H2
                            </button>
                        </div>
                        
                        <textarea 
                            id="pageContentInput" 
                            style="width: 100%; min-height: 300px; padding: 1rem; font-size: 0.9rem; border: 1px solid var(--border-color); border-radius: 6px; resize: vertical; font-family: 'SF Mono', Monaco, monospace; background: var(--bg-color); transition: var(--transition-base);"
                            placeholder="Markdownで内容を入力

# 見出し1
## 見出し2

**太字** *斜体*

- リスト項目
1. 番号付きリスト

> 引用文

`コード`

[リンク](https://example.com)

![画像](image-url)"
                            maxlength="50000"></textarea>
                    </div>
                </div>
            </div>

            <!-- ページナビゲーション -->
            <nav class="page-nav">
                <button class="btn btn-secondary" onclick="app.previousPage()" id="prevBtn" aria-label="前のページ" title="前のページ">
                    ←
                </button>
                <div id="pageDots" class="page-dots"></div>
                <button class="btn btn-secondary" onclick="app.nextPage()" id="nextBtn" aria-label="次のページ" title="次のページ">
                    →
                </button>
            </nav>
        </main>
    </div>

    <!-- 公開設定モーダル -->
    <div id="visibilityModal" class="modal-overlay">
        <div class="modal-content">
            <h3>公開設定</h3>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; margin-bottom: 0.75rem; cursor: pointer;">
                    <input type="radio" name="visibility" value="private" style="margin-right: 0.5rem;">
                    <span>🔒 完全非公開（自分のみ）</span>
                </label>
                
                <label style="display: flex; align-items: center; margin-bottom: 0.75rem; cursor: pointer;">
                    <input type="radio" name="visibility" value="public" style="margin-right: 0.5rem;">
                    <span>🌍 完全公開（誰でも閲覧可能）</span>
                </label>
                
                <label style="display: flex; align-items: center; margin-bottom: 0.75rem; cursor: pointer;">
                    <input type="radio" name="visibility" value="password" style="margin-right: 0.5rem;">
                    <span>🔐 パスワード保護（URLとパスワードを知っている人のみ）</span>
                </label>
            </div>

            <!-- パスワード設定セクション -->
            <div id="passwordSection" class="password-section" style="display: none;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">パスワード設定</label>
                <input 
                    type="text" 
                    id="passwordInput" 
                    class="modal-input"
                    placeholder="パスワードを入力（4文字以上）"
                    style="margin-bottom: 0.5rem;"
                >
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0;">
                    ※ URLを共有された人がこのパスワードを入力することでノートを閲覧できます
                </p>
            </div>

            <div class="modal-buttons">
                <button class="btn-filled" onclick="app.saveVisibilitySettings()">保存</button>
                <button class="btn-filled" onclick="app.closeVisibilityModal()" style="background: var(--text-secondary);">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- パスワード入力モーダル -->
    <div id="passwordPromptModal" class="modal-overlay">
        <div class="modal-content">
            <h3>🔐 パスワードが必要です</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">このノートはパスワードで保護されています。</p>
            
            <input 
                type="password" 
                id="passwordPromptInput" 
                class="modal-input"
                placeholder="パスワードを入力してください"
                onkeypress="if(event.key==='Enter') app.submitPassword()"
            >

            <div class="modal-buttons">
                <button class="btn-filled" onclick="app.submitPassword()">開く</button>
                <button class="btn-filled" onclick="app.closePasswordPrompt()" style="background: var(--text-secondary);">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- シェアモーダル -->
    <div id="shareModal" class="modal-overlay" onclick="if(event.target.id === 'shareModal') app.closeShareModal()">
        <div class="modal-content">
            <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">このノートを共有</h3>
            <input type="text" id="shareUrl" readonly class="modal-input" style="margin-bottom: 1rem;">
            
            <div id="sharePasswordInfo" style="display: none; background: var(--warning-color); color: white; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9rem;">
                <div style="font-weight: 600; margin-bottom: 0.25rem;">🔐 パスワード保護されています</div>
                <div>URLを受け取った人は以下のパスワードを入力する必要があります：</div>
                <div style="font-family: monospace; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; margin-top: 0.5rem;" id="sharePasswordDisplay"></div>
            </div>
            
            <div class="share-buttons">
                <button class="share-btn twitter" onclick="app.shareToTwitter()">Twitter</button>
                <button class="share-btn line" onclick="app.shareToLine()">LINE</button>
                <button class="share-btn facebook" onclick="app.shareToFacebook()">Facebook</button>
            </div>
            <button class="btn-filled" onclick="app.copyShareUrl()" style="width: 100%; margin-top: 1rem;">
                URLをコピー
            </button>
        </div>
    </div>

    <!-- トースト通知 -->
    <div id="toast" class="toast" role="alert" aria-live="polite"></div>

    <!-- Firebase SDK v8（互換モード） -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- 外部ライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    
    <!-- 設定ファイル -->
    <script src="config.js"></script>

    <!-- メインスクリプト -->
    <script src="script.js"></script>
</body>
</html>
