<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <meta name="description" content="StudyBook - 学習ノートを電子ブック化して共有できるプラットフォーム">
    <meta name="keywords" content="学習,ノート,電子書籍,共有,StudyBook">
    <meta property="og:title" content="StudyBook - 学習ノート共有プラットフォーム">
    <meta property="og:description" content="学習ノートを美しい電子ブックに変換して共有しよう">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
    
    <!-- PWA対応 -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#333333">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    
    <title>StudyBook - 学習ノート共有プラットフォーム</title>
    
    <!-- 外部CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 接続状態インジケーター -->
    <div id="connectionStatus" class="connection-status">
        <span id="connectionText">オフライン</span>
    </div>

    <!-- ローディング画面 -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loader"></div>
        <div class="loading-text" id="loadingText">読み込み中...</div>
        <div class="splash-message" style="margin-top: 2rem; font-size: 1.1rem; color: var(--text-primary); font-weight: 500;">今日は何読む？</div>
    </div>

    <!-- 認証モーダル -->
    <div id="authModal" class="auth-modal">
        <div class="auth-form">
            <h2 id="authFormTitle">ログイン</h2>
            
            <!-- Googleログインボタン -->
            <button type="button" class="btn-google" onclick="app.handleGoogleLogin()">
                <svg viewBox="0 0 24 24">
                    <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Googleでログイン
            </button>
            
            <div class="auth-divider">
                <span>または</span>
            </div>
            
            <form id="authForm" onsubmit="app.handleAuthSubmit(event)" autocomplete="on">
                <div class="form-group">
                    <label class="form-label">メールアドレス</label>
                    <input 
                        type="email" 
                        id="emailInput" 
                        class="form-input" 
                        required
                        autocomplete="username email"
                        placeholder="example@email.com"
                    >
                    <div id="emailError" class="form-error"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">パスワード</label>
                    <input 
                        type="password" 
                        id="passwordInput" 
                        class="form-input" 
                        required
                        autocomplete="current-password"
                        placeholder="6文字以上"
                        minlength="6"
                    >
                    <div id="passwordError" class="form-error"></div>
                </div>
                
                <button type="submit" class="btn-filled" style="width: 100%;">
                    <span id="authSubmitText">ログイン</span>
                </button>
            </form>
            
            <div class="auth-toggle">
                <span id="authToggleText">アカウントをお持ちでない方は</span>
                <a onclick="app.toggleAuthMode(event)" id="authToggleLink">新規登録</a>
            </div>

            <div id="passwordResetLink" style="text-align: center; margin-top: 1rem; display: none;">
                <a onclick="app.showPasswordReset(event)" style="color: var(--primary-color); font-size: 0.9rem; cursor: pointer; text-decoration: underline;">
                    パスワードを忘れた方はこちら
                </a>
            </div>

            <div style="text-align: center; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="app.closeAuthModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- ホーム画面 -->
    <div id="homeView">
        <header class="header">
            <a href="/" class="logo" aria-label="StudyBook ホーム">
                <span>📚</span>
                <span>StudyBook</span>
            </a>

            <div id="authSection">
                <button class="btn btn-secondary" onclick="app.showKeyboardHelp()" aria-label="キーボードヘルプ" title="キーボードショートカット (?)">⌨️</button>
                <button class="btn btn-primary" onclick="app.showAuthModal()" aria-label="ログイン" title="ログイン">
                    👤
                </button>
            </div>
        </header>

        <main style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem 5rem 1rem;">
            <!-- 続きから読む -->
            <div id="continueReading" style="display: none;"></div>

            <!-- マイノート（本棚UI） - 最優先表示 -->
            <section id="myBooksSection" style="display: none;">
                <h2 style="color: var(--text-primary); font-size: 1.25rem; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
                    📘 マイブック
                </h2>


                <!-- 本棚表示 -->
                <div id="bookshelfView" class="bookshelf-container">
                    <div class="shelf-unit">
                        <div id="myBookshelf" class="bookshelf"></div>
                        <div class="shelf-board"></div>
                    </div>
                </div>

                <!-- グリッド表示 -->
                <div id="gridView" style="display: none;">
                    <div id="myBooksList" class="books-grid"></div>
                </div>
            </section>


            <!-- みんなのノート -->
            <section id="publicBooksSection" style="display: none; margin-top: 3rem;">
                <h2 style="color: var(--text-primary); font-size: 1.25rem; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">みんなのノート</h2>
                <div id="publicBooksList" class="books-grid"></div>
            </section>

            <!-- 人気タグ -->
            <section id="popularTagsSection" style="display: none; margin-top: 3rem;">
                <h2 style="color: var(--text-primary); font-size: 1.25rem; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">人気のタグ</h2>
                <div id="popularTagsList" class="tags-container" style="background: var(--bg-secondary); padding: 2rem; border: 1px solid var(--border-color); border-radius: 8px;"></div>
            </section>
        </main>

        <!-- ホーム画面フッターナビゲーション -->
        <div class="footer-tabs" style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-color); border-top: 1px solid var(--border-color); z-index: 1000; padding: 0.5rem 0; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);">
            <div style="display: flex; width: 100%; max-width: 600px; margin: 0 auto;">
                <button onclick="app.showPublicBooks()" style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.5rem; background: none; color: var(--text-secondary); cursor: pointer; flex: 1; border: none; position: relative;">
                    <span style="font-size: 1.2rem;">📚</span>
                    <span style="font-size: 0.7rem;">みんなのノート</span>
                </button>
                <button id="homeShelfBtn" onclick="app.setViewMode('shelf')" style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.5rem; background: #f5f5f5; color: var(--text-primary); cursor: pointer; flex: 1; border: none; border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color); position: relative;">
                    <span style="font-size: 1.2rem;">📖</span>
                    <span style="font-size: 0.7rem;">本棚</span>
                </button>
                <button id="homeGridBtn" onclick="app.setViewMode('grid')" style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.5rem; background: none; color: var(--text-secondary); cursor: pointer; flex: 1; border: none; border-right: 1px solid var(--border-color); position: relative;">
                    <span style="font-size: 1.2rem;">✏️</span>
                    <span style="font-size: 0.7rem;">編集</span>
                </button>
                <button onclick="app.createNewBook()" style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.5rem; background: none; color: var(--text-secondary); cursor: pointer; flex: 1; border: none; position: relative;">
                    <span style="font-size: 1.2rem;">📝</span>
                    <span style="font-size: 0.7rem;">新規作成</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ビューアー/エディター画面 -->
    <div id="viewerContainer" class="viewer-container">
        <!-- ヘッダー -->
        <header class="viewer-header">
            <div class="header-group">
                <button class="btn btn-secondary" onclick="app.toggleSidebar()" aria-label="メニュー" title="目次">☰</button>
                <button class="btn btn-secondary" onclick="app.goHome()" aria-label="ホーム" title="ホーム">🏠</button>
            </div>

            <span id="pageInfo" class="page-info">1 / 1</span>

            <div class="header-group">
                <button id="visibilityBtn" class="btn btn-secondary" onclick="app.showVisibilitySettings()" aria-label="公開設定" title="公開設定">👁️</button>
                <button class="btn btn-primary" onclick="app.showShareModal()" aria-label="シェア" title="シェア">🔗</button>
            </div>
        </header>

        <!-- サイドバーオーバーレイ -->
        <div id="sidebarOverlay" class="sidebar-overlay" onclick="app.toggleSidebar()"></div>

        <!-- サイドバー -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h2 style="font-size: 1rem; font-weight: 600;">📑 目次</h2>
                <button class="btn btn-secondary" onclick="app.toggleSidebar()" aria-label="閉じる">✕</button>
            </div>
            <nav id="tocList" aria-label="目次"></nav>
        </aside>

        <!-- メインコンテンツ -->
        <main>
            <div id="pageContent" class="page-content">
                <!-- スワイプヒント（モバイル用） -->
                <div class="swipe-hint" id="swipeHint">← 左右にスワイプでページ移動 →</div>
                
                <div class="page-content-wrapper" id="pageContentWrapper">
                    <div id="viewMode">
                        <h1 id="pageTitle" style="font-size: 1.75rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border-color);"></h1>
                        <img id="pageImage" style="display: none;" alt="ページ画像">
                        <div id="pageBody" class="markdown-body"></div>
                    </div>
                    
                    <div id="editMode" style="display: none;">
                        <!-- ノートタイトル編集 -->
                        <div id="bookTitleSection" class="book-title-section" style="display: none;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">ノートタイトル</label>
                            <input 
                                type="text" 
                                id="bookTitleInput" 
                                class="form-input"
                                placeholder="ノートのタイトル"
                                maxlength="100"
                            >
                        </div>

                        <input 
                            type="text" 
                            id="pageTitleInput" 
                            class="form-input"
                            style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;"
                            placeholder="ページタイトル"
                            maxlength="100"
                        >
                        
                        <div style="border: 2px dashed var(--border-color); border-radius: 6px; padding: 2rem; text-align: center; margin: 1rem 0; cursor: pointer; transition: var(--transition-base); background: var(--bg-color); width: 100%; box-sizing: border-box;"
                             onclick="document.getElementById('imageInput').click()"
                             ondragover="event.preventDefault(); this.style.borderColor='var(--primary-color)'"
                             ondragleave="this.style.borderColor='var(--border-color)'"
                             ondrop="app.handleDrop(event)">
                            <div style="font-size: 1rem;">📷 画像をアップロード</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">クリック or ドラッグ&ドロップ（最大5MB）</div>
                            <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="app.handleImageUpload(event)">
                        </div>
                        
                        <div id="imagePreview" style="margin: 1rem 0;"></div>
                        
                        <div id="pageTagsSection" style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem;">タグ（カンマ区切り）</label>
                            <input
                                type="text"
                                id="pageTagsInput"
                                class="form-input"
                                placeholder="例: 数学, 微分積分, 大学"
                                maxlength="200"
                            >
                        </div>

                        <!-- 本の色選択 -->
                        <div id="bookColorSection" style="margin-bottom: 1rem; display: none;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem;">本の背表紙の色</label>
                            <div class="color-picker" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div class="color-option" data-color="#f8f8f8" style="background: #f8f8f8; border: 2px solid #d0d0d0;"></div>
                                <div class="color-option" data-color="#f0f0f0" style="background: #f0f0f0; border: 2px solid #c0c0c0;"></div>
                                <div class="color-option" data-color="#e8e8e8" style="background: #e8e8e8; border: 2px solid #b0b0b0;"></div>
                                <div class="color-option" data-color="#e0f2f1" style="background: #e0f2f1; border: 2px solid #b2dfdb;"></div>
                                <div class="color-option" data-color="#fff3e0" style="background: #fff3e0; border: 2px solid #ffcc02;"></div>
                                <div class="color-option" data-color="#fce4ec" style="background: #fce4ec; border: 2px solid #f8bbd9;"></div>
                                <div class="color-option" data-color="#e8f5e8" style="background: #e8f5e8; border: 2px solid #c8e6c9;"></div>
                                <div class="color-option" data-color="#e3f2fd" style="background: #e3f2fd; border: 2px solid #90caf9;"></div>
                                <div class="color-option" data-color="#f3e5f5" style="background: #f3e5f5; border: 2px solid #ce93d8;"></div>
                                <div class="color-option" data-color="#fff8e1" style="background: #fff8e1; border: 2px solid #fff176;"></div>
                                <div class="color-option" data-color="#fafafa" style="background: #fafafa; border: 2px solid #e0e0e0;"></div>
                                <div class="color-option" data-color="#f5f5f5" style="background: #f5f5f5; border: 2px solid #d5d5d5;"></div>
                            </div>
                            <input
                                type="hidden"
                                id="bookColorInput"
                                value="#f8f8f8"
                            >
                        </div>

                        <!-- エディターツールバー -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-color); border-radius: 6px; border: 1px solid var(--border-color);">
                            <button class="btn btn-secondary" onclick="app.insertImageInContent()" title="画像を挿入" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; width: 120px;">
                                📷 画像挿入
                            </button>
                            <button class="btn btn-secondary" onclick="app.insertMarkdown('**', '**')" title="太字" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                <strong>B</strong>
                            </button>
                            <button class="btn btn-secondary" onclick="app.insertMarkdown('*', '*')" title="斜体" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                <em>I</em>
                            </button>
                            <button class="btn btn-secondary" onclick="app.insertMarkdown('`', '`')" title="コード" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                &lt;&gt;
                            </button>
                            <button class="btn btn-secondary" onclick="app.insertMarkdown('## ', '')" title="見出し" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                H2
                            </button>
                        </div>
                        
                        <textarea
                            id="pageContentInput"
                            style="width: 100%; min-height: 300px; max-height: 400px; padding: 1rem; font-size: 16px; border: 1px solid var(--border-color); border-radius: 6px; resize: vertical; font-family: 'SF Mono', Monaco, monospace; background: var(--bg-color); transition: var(--transition-base); overflow-y: auto; -webkit-overflow-scrolling: touch;"
                            placeholder="Markdownで内容を入力

# 見出し1
## 見出し2

**太字** *斜体*

- リスト項目
1. 番号付きリスト

> 引用文

`コード`

[リンク](https://example.com)

![画像](image-url)"
                            maxlength="50000"></textarea>
                    </div>
                </div>
            </div>

            <!-- ページナビゲーション -->
            <nav class="page-nav">
                <button class="btn btn-secondary" onclick="app.previousPage()" id="prevBtn" aria-label="前のページ" title="前のページ">
                    ←
                </button>
                <div style="display: flex; gap: 0.25rem; align-items: center;">
                    <button id="editToggleBtn" class="btn btn-secondary" onclick="app.toggleEdit()" style="display: none;" aria-label="編集" title="編集切替">✏️</button>
                    <button id="addPageBtn" class="btn btn-primary" onclick="app.addPage()" style="display: none;" aria-label="ページ追加" title="ページ追加">➕</button>
                    <div id="pageDots" class="page-dots"></div>
                    <button id="deleteBookBtn" class="btn btn-danger" onclick="app.deleteBook()" style="display: none;" aria-label="ノート削除" title="ノート削除">🗑️</button>
                </div>
                <button class="btn btn-secondary" onclick="app.nextPage()" id="nextBtn" aria-label="次のページ" title="次のページ">
                    →
                </button>
            </nav>
        </main>
    </div>

    <!-- みんなのノート専用ページ -->
    <div id="publicNotesView" style="display: none;">
        <header class="header">
            <a href="#" class="logo" onclick="app.goHome()" aria-label="StudyBook ホーム">
                <span>📚</span>
                <span>StudyBook</span>
            </a>

            <div class="search-container">
                <input
                    type="search"
                    id="publicSearchInput"
                    class="search-input"
                    placeholder="みんなのノートを検索..."
                    aria-label="みんなのノートを検索"
                    maxlength="100"
                    autocomplete="off"
                >
                <span class="search-icon">🔍</span>
                <div id="publicSearchResults" class="search-results"></div>
            </div>

            <div>
                <!-- ホームボタンを削除 - ロゴクリックでホームに戻れるため -->
            </div>
        </header>

        <main style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem 5rem 1rem;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <h2 style="color: var(--text-primary); font-size: 1rem; margin: 0.5rem 0;">みんなのノート</h2>
                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">コミュニティで共有されている学習ノートを探索しよう</p>
            </div>

            <!-- フッタータブナビゲーション -->
            <div class="footer-tabs" style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-color); border-top: 1px solid var(--border-color); z-index: 1000; padding: 0.5rem 0; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);">
                <div style="display: flex; width: 100%; max-width: 600px; margin: 0 auto;">
                    <button onclick="app.goHome()" style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.5rem; background: none; color: var(--text-secondary); cursor: pointer; flex: 1; border: none; position: relative;">
                        <span style="font-size: 1.2rem;">📘</span>
                        <span style="font-size: 0.7rem;">マイブック</span>
                    </button>
                    <button id="publicShelfTab" class="footer-tab-btn active" onclick="app.switchPublicView('shelf')" style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.5rem; background: #f5f5f5; color: var(--text-primary); cursor: pointer; flex: 1; border: none; border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color); position: relative;">
                        <span style="font-size: 1.2rem;">📚</span>
                        <span style="font-size: 0.7rem;">本棚</span>
                    </button>
                    <button id="allNotesTab" class="footer-tab-btn" onclick="app.switchPublicView('all')" style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.5rem; background: none; color: var(--text-secondary); cursor: pointer; flex: 1; border: none; border-right: 1px solid var(--border-color); position: relative;">
                        <span style="font-size: 1.2rem;">📋</span>
                        <span style="font-size: 0.7rem;">全て</span>
                    </button>
                    <button id="taggedNotesTab" class="footer-tab-btn" onclick="app.switchPublicView('tags')" style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.5rem; background: none; color: var(--text-secondary); cursor: pointer; flex: 1; border: none; position: relative;">
                        <span style="font-size: 1.2rem;">🏷️</span>
                        <span style="font-size: 0.7rem;">タグ</span>
                    </button>
                </div>
            </div>

            <!-- すべてのノート表示 -->
            <div id="allNotesView" class="view-content">
                <!-- ソート・フィルター -->
                <div class="filter-controls" style="margin-bottom: 2rem; display: flex; gap: 0.5rem; align-items: center;">
                    <select id="sortSelect" class="form-input" style="width: auto;">
                        <option value="newest">新着順</option>
                        <option value="popular">人気順</option>
                        <option value="views">閲覧数順</option>
                        <option value="pages">ページ数順</option>
                    </select>

                    <input
                        type="text"
                        id="authorFilter"
                        class="form-input"
                        placeholder="作者で絞り込み..."
                        style="width: 200px;"
                    >

                    <button class="btn btn-secondary" onclick="app.clearFilters()" title="リセット" style="padding: 0.5rem;">🔄</button>
                </div>

                <!-- ノート一覧 -->
                <div id="publicNotesList" class="books-grid" style="margin-bottom: 2rem;"></div>

                <!-- ページネーション -->
                <div id="pagination" class="pagination" style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem;"></div>
            </div>

            <!-- 本棚表示 -->
            <div id="publicShelfView" class="view-content" style="display: none;">
                <!-- 本棚表示のソート・フィルター -->
                <div class="filter-controls" style="margin-bottom: 2rem; display: flex; gap: 0.5rem; align-items: center;">
                    <select id="shelfSortSelect" class="form-input" style="width: auto;">
                        <option value="newest">新着順</option>
                        <option value="popular">人気順</option>
                        <option value="views">閲覧数順</option>
                        <option value="pages">ページ数順</option>
                    </select>

                    <input
                        type="text"
                        id="shelfAuthorFilter"
                        class="form-input"
                        placeholder="作者で絞り込み..."
                        style="width: 200px;"
                    >

                    <button class="btn btn-secondary" onclick="app.clearShelfFilters()" title="リセット" style="padding: 0.5rem;">🔄</button>
                </div>

                <!-- 本棚コンテナ -->
                <div class="bookshelf-container">
                    <div class="shelf-unit">
                        <div id="publicBookshelf" class="bookshelf"></div>
                        <div class="shelf-board"></div>
                    </div>
                </div>

                <!-- 本棚用ページネーション -->
                <div id="shelfPagination" class="pagination" style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem;"></div>
            </div>

            <!-- タグ別表示 -->
            <div id="taggedNotesView" class="view-content" style="display: none;">
                <!-- 人気タグ一覧 -->
                <div class="popular-tags" style="margin-bottom: 2rem;">
                    <h3 style="color: var(--text-primary); margin-bottom: 1rem;">🔥 人気のタグ</h3>
                    <div id="publicPopularTagsList" class="tags-container" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 2rem;"></div>
                </div>

                <!-- 選択中のタグ -->
                <div id="selectedTagInfo" style="display: none; margin-bottom: 2rem;">
                    <h3 style="color: var(--text-primary); margin-bottom: 1rem;">
                        <span id="selectedTagName"></span> のノート
                    </h3>
                    <button class="btn btn-secondary" onclick="app.clearTagFilter()">✕ タグを解除</button>
                </div>

                <!-- タグ別ノート一覧 -->
                <div id="taggedNotesList" class="books-grid"></div>
            </div>
        </main>
    </div>

    <!-- 公開設定モーダル -->
    <div id="visibilityModal" class="modal-overlay">
        <div class="modal-content">
            <h3>公開設定</h3>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; margin-bottom: 0.75rem; cursor: pointer;">
                    <input type="radio" name="visibility" value="private" style="margin-right: 0.5rem;">
                    <span>🔒 完全非公開（自分のみ）</span>
                </label>
                
                <label style="display: flex; align-items: center; margin-bottom: 0.75rem; cursor: pointer;">
                    <input type="radio" name="visibility" value="public" style="margin-right: 0.5rem;">
                    <span>🌍 完全公開（誰でも閲覧可能）</span>
                </label>
                
                <label style="display: flex; align-items: center; margin-bottom: 0.75rem; cursor: pointer;">
                    <input type="radio" name="visibility" value="password" style="margin-right: 0.5rem;">
                    <span>🔐 パスワード保護（URLとパスワードを知っている人のみ）</span>
                </label>
            </div>

            <!-- パスワード設定セクション -->
            <div id="passwordSection" class="password-section" style="display: none;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">パスワード設定</label>
                <input 
                    type="text" 
                    id="passwordInput" 
                    class="modal-input"
                    placeholder="パスワードを入力（4文字以上）"
                    style="margin-bottom: 0.5rem;"
                >
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0;">
                    ※ URLを共有された人がこのパスワードを入力することでノートを閲覧できます
                </p>
            </div>

            <div class="modal-buttons">
                <button class="btn-filled" onclick="app.saveVisibilitySettings()">保存</button>
                <button class="btn-filled" onclick="app.closeVisibilityModal()" style="background: var(--text-secondary);">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- パスワード入力モーダル -->
    <div id="passwordPromptModal" class="modal-overlay">
        <div class="modal-content">
            <h3>🔐 パスワードが必要です</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">このノートはパスワードで保護されています。</p>
            
            <input 
                type="password" 
                id="passwordPromptInput" 
                class="modal-input"
                placeholder="パスワードを入力してください"
                onkeypress="if(event.key==='Enter') app.submitPassword()"
            >

            <div class="modal-buttons">
                <button class="btn-filled" onclick="app.submitPassword()">開く</button>
                <button class="btn-filled" onclick="app.closePasswordPrompt()" style="background: var(--text-secondary);">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- シェアモーダル -->
    <div id="shareModal" class="modal-overlay" onclick="if(event.target.id === 'shareModal') app.closeShareModal()">
        <div class="modal-content">
            <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">このノートを共有</h3>
            <input type="text" id="shareUrl" readonly class="modal-input" style="margin-bottom: 1rem;">
            
            <div id="sharePasswordInfo" style="display: none; background: var(--warning-color); color: white; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9rem;">
                <div style="font-weight: 600; margin-bottom: 0.25rem;">🔐 パスワード保護されています</div>
                <div>URLを受け取った人は以下のパスワードを入力する必要があります：</div>
                <div style="font-family: monospace; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; margin-top: 0.5rem;" id="sharePasswordDisplay"></div>
            </div>
            
            <div class="share-buttons">
                <button class="share-btn twitter" onclick="app.shareToTwitter()">Twitter</button>
                <button class="share-btn line" onclick="app.shareToLine()">LINE</button>
                <button class="share-btn facebook" onclick="app.shareToFacebook()">Facebook</button>
            </div>
            <button class="btn-filled" onclick="app.copyShareUrl()" style="width: 100%; margin-top: 1rem;">
                URLをコピー
            </button>
        </div>
    </div>

    <!-- パスワードリセットモーダル -->
    <div id="passwordResetModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-bottom: 1.5rem;">🔒 パスワードリセット</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                登録されたメールアドレスにパスワードリセット用のリンクを送信します。
            </p>

            <form id="passwordResetForm" onsubmit="app.handlePasswordReset(event)">
                <div class="form-group">
                    <label class="form-label">メールアドレス</label>
                    <input
                        type="email"
                        id="resetEmailInput"
                        class="form-input"
                        required
                        placeholder="example@email.com"
                    >
                    <div id="resetEmailError" class="form-error"></div>
                </div>

                <div class="modal-buttons">
                    <button type="submit" class="btn-filled">リセットメールを送信</button>
                    <button type="button" class="btn-filled" onclick="app.closePasswordReset()" style="background: var(--text-secondary);">キャンセル</button>
                </div>
            </form>
        </div>
    </div>

    <!-- キーボードショートカットヘルプ -->
    <div id="keyboardHelpModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="margin-bottom: 1.5rem;">⌨️ キーボードショートカット</h3>

            <div style="display: grid; gap: 1.5rem;">
                <!-- ページ操作 -->
                <div>
                    <h4 style="color: var(--primary-color); margin-bottom: 0.5rem; font-size: 1rem;">📖 ページ操作</h4>
                    <div class="shortcut-list">
                        <div class="shortcut-item">
                            <span class="shortcut-key">← / h</span>
                            <span class="shortcut-desc">前のページ</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">→ / l</span>
                            <span class="shortcut-desc">次のページ</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">↑ / k</span>
                            <span class="shortcut-desc">前のページ</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">↓ / j</span>
                            <span class="shortcut-desc">次のページ</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Home</span>
                            <span class="shortcut-desc">最初のページ</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">End</span>
                            <span class="shortcut-desc">最後のページ</span>
                        </div>
                    </div>
                </div>

                <!-- 編集・保存 -->
                <div>
                    <h4 style="color: var(--primary-color); margin-bottom: 0.5rem; font-size: 1rem;">✏️ 編集・保存</h4>
                    <div class="shortcut-list">
                        <div class="shortcut-item">
                            <span class="shortcut-key">e</span>
                            <span class="shortcut-desc">編集モード切り替え</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + S</span>
                            <span class="shortcut-desc">保存</span>
                        </div>
                    </div>
                </div>

                <!-- ナビゲーション -->
                <div>
                    <h4 style="color: var(--primary-color); margin-bottom: 0.5rem; font-size: 1rem;">🧭 ナビゲーション</h4>
                    <div class="shortcut-list">
                        <div class="shortcut-item">
                            <span class="shortcut-key">m</span>
                            <span class="shortcut-desc">目次（サイドバー）切り替え</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Esc</span>
                            <span class="shortcut-desc">モーダル・サイドバーを閉じる</span>
                        </div>
                    </div>
                </div>

                <!-- ホーム画面 -->
                <div>
                    <h4 style="color: var(--primary-color); margin-bottom: 0.5rem; font-size: 1rem;">🏠 ホーム画面</h4>
                    <div class="shortcut-list">
                        <div class="shortcut-item">
                            <span class="shortcut-key">n</span>
                            <span class="shortcut-desc">新規ノート作成</span>
                        </div>
                    </div>
                </div>

                <!-- ヘルプ -->
                <div>
                    <h4 style="color: var(--primary-color); margin-bottom: 0.5rem; font-size: 1rem;">❓ ヘルプ</h4>
                    <div class="shortcut-list">
                        <div class="shortcut-item">
                            <span class="shortcut-key">?</span>
                            <span class="shortcut-desc">このヘルプを表示</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">⌨️</span>
                            <span class="shortcut-desc">ヘッダーのキーボードボタン</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-buttons" style="margin-top: 2rem;">
                <button class="btn-filled" onclick="app.closeKeyboardHelp()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- トースト通知 -->
    <div id="toast" class="toast" role="alert" aria-live="polite"></div>

    <!-- Firebase SDK v8（互換モード） -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- 外部ライブラリは必要時に動的読み込み -->
    
    <!-- 設定ファイル -->
    <script src="config.js"></script>

    <!-- メインスクリプト -->
    <script src="script.js"></script>
</body>
</html>
